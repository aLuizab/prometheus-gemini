# Prometheus-GEMINI Alerter

Este √© o projeto de demonstra√ß√£o para a palestra **"Do Prometheus ao GPT: Uma Nova Era de Observabilidade Inteligente"**, apresentada na Cloud Native Day S√£o Paulo.

O objetivo deste projeto √© demonstrar como a Intelig√™ncia Artificial Generativa pode ser integrada a uma stack de observabilidade tradicional (Prometheus + Alertmanager) para transformar alertas t√©cnicos e cr√≠pticos em an√°lises ricas, contextualizadas e acion√°veis, enviadas diretamente para o Slack.

## Arquitetura

O fluxo da aplica√ß√£o √© simples e poderoso:

```
+-------------------+      +-----------------+      +------------------+
|  Aplica√ß√£o Demo   |----->|   Prometheus    |----->|   Alertmanager   |
| (Python/Flask)    |      |(Coleta M√©tricas)|      | (Gatilho Alertas)|
+-------------------+      +-----------------+      +------------------+
                                                           | (Webhook)
                                                           v
                                                +---------------------+      +----------------+
                                                |  Gen AI Bridge      |----->|    Vertex AI   |
                                                | (Python/Flask)      |      | (Modelo Gemini)|
                                                +---------------------+      +----------------+
                                                           |
                                                           v
                                                +---------------------+
                                                | Canal do Slack      |
                                                |(An√°lise Inteligente)|
                                                +---------------------+
```

## Funcionalidades

  - **Aplica√ß√£o Simples:** Um microservi√ßo em Flask que exp√µe m√©tricas customizadas para o Prometheus.
  - **Monitoramento Real:** Configura√ß√£o funcional do Prometheus e Alertmanager para detectar problemas de lat√™ncia e taxa de erros.
  - **Ponte Inteligente:** Um servi√ßo intermedi√°rio que recebe webhooks do Alertmanager.
  - **An√°lise com Gen AI:** O servi√ßo utiliza a SDK do Vertex AI para enviar os dados do alerta ao modelo Gemini, solicitando uma an√°lise SRE.
  - **Notifica√ß√µes Ricas:** Publica a an√°lise gerada pela IA em um canal do Slack de forma clara e bem formatada.

## Pr√©-requisitos

Antes de come√ßar, garanta que voc√™ tenha os seguintes softwares instalados:

  - [Docker](https://www.docker.com/get-started)
  - [Docker Compose](https://docs.docker.com/compose/install/)
  - Uma conta no [Google Cloud](https://cloud.google.com/)
  - Um workspace no [Slack](https://slack.com/) com permiss√µes para criar aplicativos.

## ‚öôÔ∏è Configura√ß√£o

Siga estes passos cuidadosamente para configurar o ambiente.

### 1\. Google Cloud Platform (Vertex AI)

Esta √© a etapa mais cr√≠tica. A autentica√ß√£o com a API do Google Cloud requer uma configura√ß√£o espec√≠fica.

1.  **Crie um Projeto:** Se ainda n√£o tiver um, crie um novo projeto no [Google Cloud Console](https://console.cloud.google.com/).
2.  **Ative o Faturamento:** A utiliza√ß√£o das APIs de IA **exige** que seu projeto esteja vinculado a uma conta de faturamento ativa.
      - No menu, v√° para `Faturamento` e siga as instru√ß√µes.
3.  **Ative as APIs Necess√°rias:**
      - No menu, v√° para `APIs e Servi√ßos > Biblioteca`.
      - Procure e ative as seguintes APIs:
          - `Vertex AI API`
          - `Generative Language API` (para garantir compatibilidade)
4.  **Crie uma Conta de Servi√ßo (Service Account):**
      - V√° para `IAM e admin > Contas de servi√ßo`.
      - Crie uma nova conta de servi√ßo (ex: `gemini-alerter-sa`).
      - Conceda a ela o papel de **"Usu√°rio da Vertex AI" (Vertex AI User)**.
5.  **Gere uma Chave JSON:**
      - Ap√≥s criar a conta de servi√ßo, entre nela, v√° na aba `CHAVES`.
      - Adicione uma nova chave do tipo **JSON**.
      - Um arquivo `.json` ser√° baixado. **Renomeie este arquivo para `gcp-credentials.json`** e coloque-o na raiz deste projeto.
      - **Seguran√ßa:** Adicione `gcp-credentials.json` ao seu arquivo `.gitignore` para nunca cometer este segredo no reposit√≥rio.

### 2\. Slack

1.  **Crie um App no Slack:** V√° para [api.slack.com/apps](https://api.slack.com/apps) e crie um novo aplicativo no seu workspace.
2.  **Ative Incoming Webhooks:** No menu do seu app, v√° para `Incoming Webhooks` e ative-os.
3.  **Crie um Webhook:** Adicione um novo webhook, escolhendo o canal onde os alertas devem ser postados (ex: `#alertas-ia`).
4.  **Copie a URL do Webhook.** Ela se parecer√° com `https://hooks.slack.com/services/...`.

### 3\. Arquivo de Ambiente (`.env`)

Na raiz do projeto, crie um arquivo chamado `.env` e preencha com as informa√ß√µes coletadas.

```
# .env

# Cole a URL do webhook do Slack aqui
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...

# Cole o ID do seu projeto do Google Cloud aqui (ex: meu-projeto-12345)
GCP_PROJECT_ID=seu-id-de-projeto-aqui

# Regi√£o do Google Cloud para usar a API (us-east4 √© uma boa op√ß√£o)
GCP_REGION=us-east4
```

## üöÄ Executando o Projeto

Com todas as configura√ß√µes no lugar, iniciar a stack √© muito simples.

1.  Abra um terminal na raiz do projeto.
2.  Execute o comando:
    ```bash
    docker-compose up --build
    ```
3.  Aguarde enquanto o Docker baixa as imagens e constr√≥i os containers.
4.  Ap√≥s a inicializa√ß√£o, os seguintes servi√ßos estar√£o dispon√≠veis:
      - **Aplica√ß√£o Demo:** `http://localhost:5000`
      - **Prometheus:** `http://localhost:9090`
      - **Alertmanager:** `http://localhost:9093`

## üß™ Como Demonstrar

Para gerar os alertas, execute os seguintes comandos em um novo terminal.

**Para gerar um alerta de alta taxa de erros:**

```bash
# Gera 50 requests que resultar√£o em erro HTTP 500
hey -n 50 -c 10 http://localhost:5000/error
```

**Para gerar um alerta de alta lat√™ncia:**

```bash
# Gera requests lentos
hey -n 20 -c 5 http://localhost:5000/slow
```

Ap√≥s executar um dos comandos, observe o alerta aparecer primeiro no Prometheus (`Alerts`), depois no Alertmanager, e finalmente, a an√°lise completa gerada pela IA chegar√° no seu canal do Slack\!

## ‚ö†Ô∏è Solu√ß√£o de Problemas

Durante o desenvolvimento, encontramos alguns erros comuns. Se algo der errado, verifique estes pontos:

  - **Alerta `PENDING` no Prometheus:** Se o alerta n√£o passa para `FIRING`, verifique a cl√°usula `for` e a janela de tempo da `rate()` no arquivo `prometheus/alert.rules.yml`. Para demos, valores baixos (`for: 1s` e `rate([3m])`) funcionam melhor.
  - **Erro `404 model not found`:**
      - Verifique se o **faturamento** e as **APIs** (`Vertex AI` e `Generative Language`) est√£o ativos no seu projeto GCP.
      - Confirme se a **regi√£o** (`GCP_REGION`) no seu `.env` est√° correta.
      - **Crucial:** Verifique o nome do modelo no `gen-ai-bridge/bridge.py`. Descobrimos que o nome completo e versionado (`gemini-1.5-pro`) foi o que funcionou para o nosso projeto.
  - **Erro `401 Unauthorized` ou `CREDENTIALS_MISSING`:** Este erro indica que a autentica√ß√£o via Chave de API n√£o √© aceita. A solu√ß√£o √© usar uma **Service Account** com o arquivo JSON, conforme descrito no guia de configura√ß√£o.
  - **Erro `403 SERVICE_DISABLED`:** Confirma que uma API espec√≠fica (`Vertex AI` ou `Generative Language`) n√£o est√° ativa no seu projeto. Use o link no erro para ativ√°-la.

## Licen√ßa

Este projeto √© distribu√≠do sob a licen√ßa MIT. Veja o arquivo `LICENSE` para mais detalhes.